/*
 (c) 2011 - 2014 Magnetic Media Online, Inc.
 Version: 0.7
 Date: 1422999930.9999282
 Privacy: http://www.magnetic.com/privacy/corporate-privacy-policy/
*/
if("undefined"==typeof _mag){var _mag={};_mag.settings={}}"undefined"==typeof console&&(console={},console.log=function(){}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),function(){function e(){t.initSettings(),n.init(r),r.bestTemplateResults=i.init(r.templates)||{},r.intervals=r.maxTries,t.searchReady()||(t.log("starting intervals"),r.readyInterval=window.setInterval(t.searchReady,100)),r.debugMode&&(_mag.Smag=t,_mag.PixelsController=n,_mag.Parser=i)}var r="settings"in _mag?_mag.settings:{},t={initSettings:function(){t.log("init settings."),r.defaultKeywords="keyword",r.publisherKeywords="kw"in _mag?_mag.kw:null,r.ns=null,r.keywordSource="pub",r.startTime="startTime"in _mag?_mag.startTime:"0",r.tagVersion="0.7",r.executeTime=(new Date).getTime(),r.debugMode="debugMode"in r&&r.debugMode?!0:!1,r.isIFrame=~~(window!=window.top),r.isSecure="https:"==document.location.protocol,r.protocol=r.isSecure?"https:":"http:",r.currentURL=window.location,r.publicHost=t.getPublicHost(),r.refURL=t.getReferrerUrl(),r.title=document.title.substr(0,150),r.urlParams=window.location.search.substr(1),r.maxTries=1,r.readyInterval=null,r.magURL=r.protocol+"//d3ezl4ajpp2zy8.cloudfront.net",r.pixelURL=r.protocol+"//techspot-computers.t.domdex.com/search.js",r.pixelFired=!1,r.queryStringObject=t.getQueryStringObject(),r.pathnameArray=t.getPathnameArray(),r.excludedTerms={search:!0},r.templates=[{id:1961,keyword:"q",name:"Result Page",pairings:{},url:"techspot.com"}],r.conversionPixelsMap=[],r.retargetingPixelsMap=[],r.conversionPixels="conversionPixels"in _mag?_mag.conversionPixels:r.conversionPixelsMap,r.retargetingPixels="retargetingPixels"in _mag?_mag.retargetingPixels:r.retargetingPixelsMap,t.log(r)},getReferrerUrl:function(){var e=document.referrer;return(void 0==e||""==e)&&(e=_mag.refUrl),void 0==e&&(e=""),e.length>147&&(e=e.substr(0,147)+"..."),t.log("Smag.getReferrerUrl: Referrer url "+e),e},searchReady:function(){if(t.log("Smag.searchReady - interval: "+r.intervals),!r.pixelFired){var e=r.bestTemplateResults.keyword;return e?t.stopSearch(e,"Smag.searchReady: found page kws: "+e+" -- clear ing interval"):(r.intervals--,r.intervals<=0&&t.stopSearch(null,"Smag.searchReady - page kws not found - forcing track without")),!0}},stopSearch:function(e,n){e&&(r.bestTemplateResults.ns=t.decodeKeywords(e)),t.log(n),t.trackQuery(),window.clearInterval(r.readyInterval)},escapeRegExp:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},getPublicHost:function(){var e=window.location.hostname.split("."),r=e.length;return 3==r&&"uk"!=e[r-1]&&e.shift(),t.log("Smag.getPublicHost: Public host is "+e.join(".")),e.join(".")},getQueryStringObject:function(){for(var e=window.location.search.substring(1),r=e.split("&"),t={},n=0;n<r.length;n++){var i=r[n].split("=");t[i[0]]=i[1]}return t},getPathnameArray:function(){for(var e=window.location.pathname.split("/"),r=[],t=0;t<e.length;t++)e[t].trim().length&&r.push(decodeURIComponent(e[t].trim()));return r},trackQuery:function(){t.log("trackingQuery");var e=r.publisherKeywords;r.keywordSource="pub",null==e&&(e=r.defaultKeywords,r.keywordSource="defkwd"),r.bestTemplateResults.ns&&(e=r.bestTemplateResults.ns,r.keywordSource="page");var i=t.buildSearchTrackingUrl(e);document.body.appendChild(n.buildScript(i)),r.pixelFired=!0,t.log(i)},log:function(e){r.debugMode&&console.log(e)},buildSearchTrackingUrl:function(e){var n=t.decodeKeywords(e),i={k:n,ks:r.keywordSource,pk:r.publisherKeywords,s:"1",t1:r.startTime,t2:r.executeTime,t3:(new Date).getTime(),v:r.tagVersion,u:r.currentURL,r:r.refURL,ifr:r.isIFrame,tit:r.title};for(var a in r.bestTemplateResults)i[a]=r.bestTemplateResults[a];return t.log("Smag.buildSearchTrackingUrl: Search params are "+t.encodeQueryData(i)),r.pixelURL+"?"+t.encodeQueryData(i)},decodeKeywords:function(e){var r=e.replace(/\+/g," ").replace(/&/g," and ").replace(/\|/g," or ").replace(/\(|\)|\'| +(?= )/g,"").replace(/ AND | OR /g," ").replace(/"/g,"");return decodeURIComponent(r)},encodeQueryData:function(e){var r=[];for(var t in e){var n=e[t]?encodeURIComponent(e[t]):"";r.push(encodeURIComponent(t)+"="+n)}return r.join("&")}},n={init:function(e){e.conversionPixels!=[]&&n.firePixels(e.conversionPixels),e.retargetingPixels!=[]&&n.firePixels(e.retargetingPixels)},firePixels:function(e){for(var r=0;r<e.length;r++)if("undefined"!==e[r].pages)for(var t=0;t<e[r].pages.length;t++)if(n.matchCurrentUrl(e[r].pages[t])){var i=n.buildPixel(e[r]);document.body.appendChild(i)}},buildPixel:function(e){var r=null;return e.js_url?r=n.buildScript(e.js_url):e.img_url&&(r=n.buildImage(e.img_url)),r},buildScript:function(e){var r=document.createElement("script");return r.type="text/javascript",r.src=e,r},buildImage:function(e){var r=document.createElement("img");return r.src=e,r.style="display: none;",r.height=1,r.width=1,r},matchCurrentUrl:function(e){var n=r.currentURL.href;n=n.split("#")[0],n=n.replace(/\/$/,""),target_url_regex=new RegExp(e,"gi");var i=n.match(target_url_regex)?!0:!1;return t.log("Smag.matchCurrentUrl: CurrentUrl: "+n+", TargetUrl: "+e+", matched: "+i),i},matchCurrentDomain:function(e){var n=r.publicHost,i=new RegExp(e,"gi");return t.log("Smag.matchCurrentDomain: CurrentDomain: "+n+", TargetDomain: "+e),n.match(i)?!0:!1}},i={init:function(e){if("undefined"!=typeof e&&null!=e&&e.length>0){for(var r,t,a=null,o=0,l=0;l<e.length;l++){var s=e[l];if(n.matchCurrentDomain(s.url)){r=i.parsePairings(s);var u=i.countSuccessfulPairings(r);u>=o&&(o=u,a=s)}}return a&&(t=i.parseDOMWithTemplate(a),t.ns=i.parseKeyword(a.keyword),t.tid=a.id),t}},parseKeyword:function(e){return i.isNumeric(e)?r.pathnameArray[parseInt(e,10)]:r.queryStringObject[e]},parsePairings:function(e){var r={};for(var t in e.pairings)r[t]=i.getElementByXPath(e.pairings[t]);return r},parseBreadcrumb:function(e){var r=/(\w+.?[>\|/].?)+\w+/g,t=/(\||>|\.)/g;if(e.match(r)){var n=e.match(t),a=n.length>0?n[0]:void 0;if("undefined"!=typeof a){for(var o=e.split(a),l=0;l<o.length;l++)o[l]=i.collapseWhiteSpace(o[l]);return o}}},countSuccessfulPairings:function(e){var r=0;for(var t in e)null!==e[t]&&"undefined"!=typeof e[t]&&r++;return r},parseDOMWithTemplate:function(e){var r={};for(var t in e.pairings)switch(t){case"bc":r[t]=i.parseBreadcrumb(e.pairings[t]);break;default:r[t]=i.getTextByXPath(e.pairings[t])}return r},getElementByXPath:function(e){return document.evaluate(e,document,null,9,null).singleNodeValue},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},getText:function(e){var r,t="",n=0,a=e.nodeType;if(a){if(1===a||9===a||11===a){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)t+=i.getText(e)}else if(3===a||4===a)return e.nodeValue}else for(;r=e[n++];)t+=i.getText(r);return t},collapseWhiteSpace:function(e){return e=e.replace(/\s+/g," "),e.replace(/^\s+|\s+$/g,"")},getTextByXPath:function(e){var r=i.getElementByXPath(e);if(null!==r)return i.collapseWhiteSpace(i.getText(r))}};e()}();