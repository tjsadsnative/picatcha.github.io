define(["jquery","managers/components.desktop","version!fly/managers/debug","version!fly/managers/gpt","managers/page-vars","managers/tealium","managers/guid","managers/ad","version!fly/components/base"],function(e,t,n,r,i,s,o,u){n=n.init("imageGalleryModal"),e.widget("cnet.imageGalleryModal",e.fly.base,{options:{domain:"http://cnet1.cbsistatic.com",assetsPath:"/fly/"+i.assetsVersion.version,cssPath:"/bundles/cnetcss/css/image_gallery/single.desktop.css",url:"",index:1},cssLoadPath:"",url:"",hostUrl:"",hostState:{},hostAdData:{},hostGuid:0,hasSkin:!1,hasSkinLockNarrow:!1,isHostGallery:!1,_create:function(){var t=this;this._setup();if(this.$element.attr("href")&&this.$element.attr("href").indexOf("/holiday-gift-guide/")>-1)return!0;this.$element.on("click",function(n){t.cssLoadPath=i.environment=="prod"?t.options.domain+t.options.assetsPath+t.options.cssPath:t.options.cssPath,n.preventDefault(),t._clickControl();var r="",s=e(n.target).closest("[section],[id]");for(var o=0;o<3;o++)s.attr("section")?r=s.attr("section")+"|"+r:s.attr("id")&&(r=s.attr("id")+"|"+r),s=s.parent().closest("[section],[id]");r=r.slice(0,r.length-1),window.dwTag=r})},_storeHostPageData:function(){this.hostUrl=window.location.href,this.hostState=window.history.state,this.hostAdData=e.extend(!0,{},i.ads.data),this.hostTracking=e.extend(!0,{},i.tracking),this.hostImage=e('meta[property="og:image"]').attr("content").trim(),this.hostGuid=o.getViewGuid(),this.options.url!==""?this.url=this.options.url:this.url=this.$element.attr("href")},_clickControl:function(){var a=this,f=e("body");$htmlTag=e("html");if(e("#bodyWrapper").length>0)n.log("IGM: replacing gallery modal"),e("#bodyWrapper").data("persist","true"),e("#bodyWrapper .closeModal").trigger("click"),f.removeClass("overflow"),$htmlTag.removeClass("overflow"),e("#bodyWrapper").addClass("loadingArea"),e("#bodyWrapper #rbSkin").empty();else{n.log("IGM: setting up gallery modal");var l=e("<div id='bodyWrapper' class='loadingArea'><div id='rbSkin'></div></div>");f.append(l),f.addClass("galleryModal"),this._loadCss(this.cssLoadPath,"galleryCSS")}i.tracking.data.pageType=="image_gallery"&&(a.isHostGallery=!0),a._storeHostPageData();var c=window.location.search,h=/ab=.*&/,p=/ab=.*/;h.test(c)?c=c.replace(h,""):p.test(c)&&(c=c.replace(p,"")),e.ajax({url:this.url+this.options.index+"/xhr/"+c,dataType:"json",context:document.body}).done(function(l){n.log("Gallery loaded"),a.hasSkin=e("body.skinAd").length?!0:!1,a.hasSkinLockNarrow=e("body.skinlocknarrow").length?!0:!1,i.ads.data=l.adData,i.tracking.data=l.trackingData,o.resetViewGuid(),s.init(l.trackingData),u.setupTargeting(),s.trackPageLoad(e.extend(!0,l.trackingData,{viewguid:o.getViewGuid(),title:l.trackingData.photoGalleryTitle,_pageViewGuid:o.getViewGuid(),_topicPrimaryId:l.trackingData.topicId[0],_pageUrl:a.url,pageTitle:l.trackingData.photoGalleryTitle,pageUrl:a.url}));var c=e(l.template);e("#bodyWrapper #rbSkin").length==0&&e("#bodyWrapper").append('<div id="rbSkin"></div>'),e("#bodyWrapper #rbSkin").append(c),e("#bodyWrapper").removeClass("loadingArea"),t.process(e("#bodyWrapper"));try{r.init(i.ads.data.gpt),n.log("item.adData: ",i.ads.data.gpt)}catch(h){n.log("gpt.init had trouble: ",h)}try{r.loadAds(),n.log("test loadAds")}catch(h){n.log("gpt.loadAds(); had trouble: ",h)}this.$close=e('[data-item="modal-close"]'),this.$close.on("click",function(){a._closeModal(f,l.trackingData)})}).fail(function(){a.hasSkin||f.removeClass("skinAd"),this.hasSkinLockNarrow||f.removeClass("skinlocknarrow"),f.removeClass("galleryModal"),e("#bodyWrapper").remove()})},_closeModal:function(t,n){this.hasSkin||t.removeClass("skinAd"),s.trackCustomEvent("trackCloseGallery",{_articleTitle:n.photoGalleryTitle,_articleId:n.photoGalleryId,_authorPrimaryName:n.articleAuthorName,_articleType:n.articleType,_pageType:n.pageType,siteSection:n.siteSection,siteEdition:n._siteEdition,_siteTypeDevice:n._siteTypeDevice,_siteHier:n.siteHier,_pageViewGuid:n._pageViewGuid,clickGenericText:"close-gallery"},"trackClick"),i.tracking=this.hostTracking,i.ads.data=this.hostAdData,window.history.replaceState(this.hostState,"",this.hostUrl),e('meta[property="og:image"]').attr("content",this.hostImage),e("title").text(this.hostTracking.data._pageTitle),o.resetViewGuid(this.hostGuid),this.hasSkinLockNarrow||t.removeClass("skinlocknarrow"),this.isHostGallery||(t.removeClass("overflow"),$htmlTag.removeClass("overflow")),e("#bodyWrapper").data("persist")==="true"?(e("#bodyWrapper #rbSkin").remove(),e("#bodyWrapper").data("persist",null)):(e("#bodyWrapper").remove(),t.removeClass("galleryModal"),e(window).resize())},_loadCss:function(t,n){var r=document.createElement("link");r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.setAttribute("id",n),r.setAttribute("href",t),typeof r!="undefined"&&e("#"+n).length==0&&document.getElementsByTagName("head")[0].appendChild(r)}})})