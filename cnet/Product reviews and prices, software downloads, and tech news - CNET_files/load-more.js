define(["jquery","version!fly/managers/gpt","managers/page-vars","version!fly/utils/object-helper","version!fly/utils/string-helper","version!fly/utils/string-vars","version!fly/managers/debug","version!fly/managers/history","translations/load-more","version!fly/managers/components","managers/ad","components/loading","version!libs/jquery/lazyload","version!fly/components/load-more-scroll"],function(e,t,n,r,i,s,o,u,a,f,l){var c=e.mobile?"vclick":"click",h=o.init("loadMore");e.widget("fly.loadMore",e.fly.loadMore,{options:{threshold:null,pushState:{currentPage:1,title:function(e){return"{title}"+(e.page>1?" - "+a.page+" {page}":"")},description:e('meta[name="description"]').attr("content")},loader:{text:{idle:a.loadMore}}},_handleResponse:function(r){this._super(r),this.loader.getState()!=="end"&&f.process(this.$element),this.options.data.lastAssetId=r.lastAssetId,this._lazyLoadImages(),r.adData&&r.adData.gpt&&(n.ads.data=e.extend(!0,r.adData,{gpt:{targeting:n.ads.data.gpt.targeting}}),l.setupTargeting(),t.init(n.ads.data.gpt),t.loadAds())},_create:function(){this.options.pushState.enabled!==!1&&this.options.pushState.currentPage>1&&this._removePageFromTitleAndDescription(),this._super();var e=this;this.options.pushState.enabled!==!1&&this.options.pushState.currentPage>1&&(this._changeTitleForPage(this.options.pushState.currentPage),e._changeDescriptionForPage(this.options.pushState.currentPage))},_removePageFromTitleAndDescription:function(){var t=new RegExp("(.*) - "+a.page+" \\d+$","i"),n=document.title.match(t);n!==null&&n.length==2&&(document.title=n[1]);if(this.options.pushState.description){var r=this.options.pushState.description.match(t);r!==null&&r.length==2&&(this.options.pushState.description=r[1],e('meta[name="description"]').attr("content",this.options.pushState.description))}},_changeTitleForPage:function(e){document.title=document.title+" - "+a.page+" "+e},_changeDescriptionForPage:function(t){e('meta[name="description"]').attr("content",this.options.pushState.description+" - "+a.page+" "+t)},_changeLoaderHref:function(e){this.loader.$element.children("."+this.options.loader.classes.base).attr("href",e)},_setupLoader:function(){this.loader=e.cnet.loading(this.options.loader),this.$element.next("[data-no-js]").remove(),this.loader.$element.attr("data-load",this.id).insertAfter(this.$element),this._lazyLoadImages()},_setupEvents:function(){if(this.options.threshold===null){var t={};t[c+' [data-load="'+this.id+'"]']="_handleLoadClick",this._on(this.$document,t)}else e.support.touch?this._on(this.$document,{scrollstop:"_checkScroll"}):this._on(this.$document,{scroll:e.throttle(100,this._checkScroll)}),this._on({loadmorescrolloaded:this.loader.remove})},_checkScroll:function(){var e=this.options,t,n;if(e.disabled||this.isLoading||this.$element.is(":hidden"))return;t=this.$window.scrollTop()+this.$window.height(),n=this.$element.offset().top+this.$element.outerHeight(),n-t<e.threshold&&this.load()},_destroy:function(){this.loader.destroy(),this.loader.$element.remove(),this.history&&this.history.stop()},_lazyLoadImages:function(){h.log("lazyLoadImages"),this.$element.find("img.lazy").lazyload({failure_limit:2e3,skip_invisible:!1,threshold:200}).removeClass("lazy")}})})