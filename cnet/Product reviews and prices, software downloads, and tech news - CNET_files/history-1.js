define(["jquery","version!fly/utils/string-vars"],function(e,t){var n=window.history,r=e(window),i,s=0,o,u="pushState"in n&&"replaceState"in n&&!(window.navigator.userAgent.indexOf("Firefox")>=0&&window.top!==window)&&window.navigator.userAgent.search(/CriOS/)===-1,a=function(e,t){e=e||{},s+=1,this.id="history-"+s,this.title=e.title,this.route=e.route,this.originalTitle=document.title,t&&this.navigate(t,{replace:!0})};return a.prototype={constructor:a,navigate:function(r,i){if(!u)return!1;e.extend(!0,r,{historyId:this.id}),i=i||{};var s=i.title||this.title,o=i.url||this.route;s=t.compile(e.isFunction(s)?s(r):s,e.extend({title:this.originalTitle},r)),o=t.compile(e.isFunction(o)?o(r):o,r),n[i.replace?"replaceState":"pushState"](r,s,o),s&&(document.title=s)},stateChange:function(t){if(!u)return!1;var i=this;r.on("popstate."+this.id,function(){var r=n.state||{};r.historyId===i.id&&e.isFunction(t)&&t(r)})},stop:function(){if(!u)return!1;r.off("popstate."+this.id)}},{init:function(e,t){return new a(e,t)}}})