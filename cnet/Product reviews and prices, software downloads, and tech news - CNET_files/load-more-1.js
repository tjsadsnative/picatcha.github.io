define(["jquery","version!fly/utils/object-helper","version!fly/utils/string-helper","version!fly/utils/string-vars","version!fly/managers/debug","version!fly/managers/history","version!fly/components/base","version!fly/components/loading"],function(e,t,n,r,i,s){var o=e.mobile?"vclick":"click",u=i.init("loadMore");e.widget("fly.loadMore",e.fly.base,{options:{url:null,data:{},responseKey:"loadMore",pushState:{enabled:!1,route:"./{page}",title:function(e){return"{title}"+(e.page>1?" - Page {page}":"")}},loader:{disabled:!1,initState:"idle",template:'<a class="{baseClass} {stateClass}"><span class="text">{text}</span></a>',classes:{base:"load-more"},text:{idle:"Load More"}}},isLoading:!1,id:null,data:{},loader:null,_create:function(){var e=this.options;this._setup(),this.id=this.$element.attr("id"),this.id||(this.id="uid-"+Math.floor(Math.random()*1e5),this.$element.attr("id",this.id)),this._setupLoader(),this._setupEvents(),e.pushState.enabled&&this._setupPushState()},_setupPushState:function(){var e=this,t=this.options;this.history=s.init(t.pushState),this._on({loadmoreloaded:function(t,n){var r=n.response||{},i=r.state||{};e.history.navigate(i,{replace:!0})}})},_setupEvents:function(){var e={};e[o+' [data-load="'+this.id+'"]']="_handleLoadClick",this._on(this.$document,e)},_setupLoader:function(){this.loader=e.fly.loading(this.options.loader),this.loader.$element.attr("data-load",this.id).insertAfter(this.$element)},_handleLoadClick:function(e){e.preventDefault();if(this.isLoading)return;this.load()},load:function(){var t=this,n=this.options;if(this.isLoading)return;if(this._trigger("load")===!1)return;u.log("load initiated ",{data:n.data,url:n.url}),this.isLoading=!0,this.loader.update("loading"),e.ajax({type:"GET",dataType:"json",url:n.url,data:n.data}).done(e.proxy(this._handleResponse,this)).fail(e.proxy(this._handleResponseFailure,this))},_handleResponse:function(r){var i=this.options,s={};r=t.deepFind(r,i.responseKey)||{};if(!r.html){this._handleResponseFailure(r);return}u.log("response success: ",r),this.loader.update("idle"),this.$element.append(r.html),r.data&&(r.data=e.extend({},i.data,r.data),this._setOption("data",r.data)),this._trigger("loaded",null,{response:r}),n.toBool(r.hasMore)||(this.loader.update("end"),this.destroy()),this.isLoading=!1},_handleResponseFailure:function(e){u.log("response failure: ",e),this.loader.update("error"),this.destroy()},_destroy:function(){this.loader.destroy(),this.history&&this.history.stop()},_setOption:function(e,t){e==="data"&&this.$element.data("data",t),this._super(e,t)}})})